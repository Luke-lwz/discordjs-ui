"use strict";var uuid=require("uuid"),nodeLocalstorage=require("node-localstorage"),discord_js=require("discord.js");function createButtonCache(a){const o=new Map;return setInterval(()=>{var e,t,r=Date.now();for([e,t]of o)t.ttl<r&&o.delete(e)},1e3),{set:function(e,t,r){t={fn:t,ttl:Date.now()+1e3*a,currentPathname:r},o.set(e,t)},get:function(e){return o.get(e)}}}const ARGS_DIVIDER=">",PREFIX_LENGTH=12,fs=require("fs"),path=require("path");function getRoutesFromCustomRoutes(e=[]){return e.forEach(e=>{removeFirstLastSlash(e.route).split("/")}),[]}function removeFirstLastSlash(e){return e.replace(/^\/|\/$/g,"")}function getRoutesFromDirectory(e){var t=path.dirname(require.main.filename),t=path.join(t,(e||"/ui").replace("/",""));if(!fs.existsSync(t))throw new Error("UI directory not found at "+t);if(fs.readdirSync(t).length)return getFileTree(t);throw new Error("No files found in UI directory at "+t)}const ALLOWED_FILE_EXTENSIONS=[".js",".ts"],ALLOWED_FILE_NAMES=["ui","route"],EXCLUEDED_DIRECTORIES_REGEX=[/^_.*$/,/^\(.*$/],getFileTree=(i,e=0)=>{const c=[];return fs.readdirSync(i).forEach(t=>{var r=path.join(i,t),e=path.join("",t),a=fs.statSync(r),o={path:r,route:e,isDirectory:a.isDirectory(),children:[],component:void 0};if(a.isDirectory())EXCLUEDED_DIRECTORIES_REGEX.some(e=>e.test(t))||(o.children=getFileTree(r,e),c.push(o));else{var a=path.extname(t),n=path.basename(t,a);if(ALLOWED_FILE_EXTENSIONS.includes(a)&&ALLOWED_FILE_NAMES.includes(n))try{var s=require(r);o.component=s?.default||s||void 0,o.route=e.replace(a,""),o.component&&"function"==typeof o.component&&c.push(o)}catch(e){throw new Error(`Error loading file ${r}: `+e.message)}}}),c},maxLength=100,uuidLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/uuid"),routeLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/route");function encodeRoute(e,t){let r=""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}r`+ARGS_DIVIDER+e;var a;return r.length>maxLength&&(a=routeLocalStorage.getItem(r),r=a?""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+a:(a=uuid.v4(),routeLocalStorage.setItem(r,a),uuidLocalStorage.setItem(a,e),""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+a)),r}function getRouteFromUUID(e){return uuidLocalStorage.getItem(e)}var __classPrivateFieldGet=function(e,t,r,a){if("a"===r&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e===t&&a:t.has(e))return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e);throw new TypeError("Cannot read private member from an object whose class did not declare it")};function getBuilders(a,o,n){var s,i;console.log("DiscordButtonBuilder",discord_js.ButtonBuilder);class e extends discord_js.ButtonBuilder{constructor(){super(),s.add(this)}navigateTo(e,t){return e=getNewPathNameWithSearchParams(e,t?.searchParams),__classPrivateFieldGet(this,s,"m",i).call(this,encodeRoute(e,a)),this.setCustomId=null,this}onClick(e,t){if(!t)throw new Error("onClick requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory.");var r=a.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<r+t.length)throw new Error(`Key is too long (max: ${100-r}).`);return o.set(t,e,n),__classPrivateFieldGet(this,s,"m",i).call(this,t),this.setCustomId=null,this}}return s=new WeakSet,i=function(e){if(this.setCustomId)return this.setCustomId(e),this;throw new Error("Use only one of navigateTo or onClick methods.")},console.log("ButtonBuilder",e),{ButtonBuilder:e}}function createUIRender(r){return{render:async function(e,t=0){try{r?.deffered||r?.replied?await r?.editReply?.(e):r?.message?await r?.update?.(e):await r?.reply?.(e)}catch(e){console.error(e)}},deferRender:async function(){try{r?.message?await r?.deferUpdate?.():await r?.deferReply?.()}catch(e){console.error(e)}}}}function createNavigation(u,l,d,e,m="ui",h){return{navigate:function e(t,r={}){var a,o,n,s,i,c=getBuilders(m,h,t).ButtonBuilder;r.blank||({uiFn:r,routeName:t,params:a,searchParams:o,cleanPathname:n}=getUIFnAndRouteNameAndParams(t=getNewPathNameWithSearchParams(t,r?.searchParams),u),{render:s,deferRender:i}=createUIRender(l),"ui"===r?.route?r?.component?.({interaction:l,navigate:e,pathname:n||null,route:t,params:a,searchParams:o,globalMetadata:d,ButtonBuilder:c,render:s,deferRender:i}):"route"===r?.route&&r?.component?.({navigate:e,pathname:n||null,route:t,params:a,searchParams:o,globalMetadata:d}))}}}function getUIFnAndRouteNameAndParams(e,t){const s={};let i="/";var r=new URL("https://lol.lol"+decodeURI(e));e=r.pathname;const a={};r.searchParams.forEach((e,t)=>{a[t]=e});var c=t;const u=e.split("/");""===u[0]&&u.shift();let l=!1;u.forEach((r,a)=>{if(!l){let t=!1;for(let e=0;e<c.length;e++){var o,n=c[e];if(n.isDirectory){if(n.route===r)return i+="/"+r,c=n.children,t=!0;if(/\[\.\.\..*\]/g.test(n.route)&&(o=n.route.replace("[","").replace(".","").replace(".","").replace(".","").replace("]",""),s[o]=u.slice(a).join("/"),i+="/:..."+o,e=c.length),/\[.*\]/g.test(n.route))return o=n.route.replace("[","").replace("]",""),s[o]=decodeURI(r),i+="/:"+r,c=n.children,t=!0}}t||(l=!0)}});r=c.find(e=>!1===e.isDirectory);return l||!r?(console.log("Route not found ("+e+")"),{}):"function"!=typeof r.component?(console.error("Component is not a function ("+e+")"),{}):{uiFn:r,routeName:i,params:s,searchParams:a,cleanPathname:decodeURI(e)}}function getNewPathNameWithSearchParams(e,t){var r;return t?((r=new URL("https://lol.lol"+decodeURI(e))).search=new URLSearchParams(t).toString(),r.pathname+r.search):e}function createRegisterSlashCommandsFunction(e){const{clientId:a,token:o,guildId:n}=e;return async e=>{var t=(new discord_js.REST).setToken(o);try{console.log("Started refreshing application (/) commands.");var r=e?.map(e=>e?.command?.toJSON())?.filter(e=>e)||[];await t.put(n?discord_js.Routes.applicationGuildCommands(a,n):discord_js.Routes.applicationCommands(a),{body:r}),console.log("Successfully reloaded application (/) commands.")}catch(e){console.error(e)}}}function createUI(e){const{prefix:R="ui",routeDirectory:t="/ui",customRoutes:r=null,useFunctionalButtons:p=!1,functionalButtonTtl:a=1800,globalMetadata:I,messageDefault:E={},slashCommands:D=[],slashCommandRegisterFunction:o=null}=e||{};if(0<D.length&&!o)throw new Error("slashCommandRegisterFunction is required when slashCommands are provided");if(R.length>PREFIX_LENGTH)throw new Error("Prefix length cannot be more than 12 characters");if(R.includes(ARGS_DIVIDER))throw new Error(`Prefix cannot contain '${ARGS_DIVIDER}' character`);o&&0<D?.length&&o(D);const S=r?getRoutesFromCustomRoutes(r):getRoutesFromDirectory(t),w=createButtonCache(a);async function v(e,t){e=createNavigation(S,e,I).navigate;e(t)}return{openUI:v,onInteraction:function(e){if(e?.isChatInputCommand()){const g=e["commandName"];var t=D.find(e=>e?.command?.name===g);t&&(t=(t||{})["navigateTo"],t)&&v(e,t)}else if(e?.isButton()){var{customId:t=""}=e||{};if(t?.startsWith(R+ARGS_DIVIDER)){var[t,r,...a]=t.split(ARGS_DIVIDER);if(t===R){var o,n,s,i,c=getBuilders(R,w,"")["ButtonBuilder"],{render:u,deferRender:l}=(console.log("ButtonBuilder",c),createUIRender(e)),d=createNavigation(S,e,I,E,R,w)["navigate"];switch(r){case"n":var[m,h]=a;switch(m){case"c":var f=getRouteFromUUID(h);if(!f)return;d(f);break;case"r":d(h)}break;case"f":p&&([m]=a,{routeName:o,params:n,searchParams:s,cleanPathname:i}=getUIFnAndRouteNameAndParams((m=w.get(m)).currentPathname,S),i={pathname:i||null,route:o,params:n,searchParams:s,interaction:e,navigate:d,ButtonBuilder:c,globalMetadata:I,render:u,deferRender:l},m?.fn?.(i))}}}}}}}exports.createRegisterSlashCommandsFunction=createRegisterSlashCommandsFunction,exports.createUI=createUI;