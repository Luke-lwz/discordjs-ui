"use strict";var uuid=require("uuid"),nodeLocalstorage=require("node-localstorage"),discordjs=require("discord.js"),async_hooks=require("async_hooks");function _interopNamespaceDefault(o){var r=Object.create(null);return o&&Object.keys(o).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(o,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return o[e]}}))}),r.default=o,Object.freeze(r)}var discordjs__namespace=_interopNamespaceDefault(discordjs);function createButtonCache(r){const n=new Map;return setInterval(()=>{var e,t,o=Date.now();for([e,t]of n)t.ttl<o&&n.delete(e)},1e3),{set:function(e,t,o){t={fn:t,ttl:Date.now()+1e3*r,currentPathname:o},n.set(e,t)},get:function(e){return n.get(e)}}}const ARGS_DIVIDER=">",PREFIX_LENGTH=12,fs=require("fs"),path=require("path");function getRoutesFromCustomRoutes(e=[]){return e.forEach(e=>{removeFirstLastSlash(e.route).split("/")}),[]}function removeFirstLastSlash(e){return e.replace(/^\/|\/$/g,"")}function getRoutesFromDirectory(e){var t=path.dirname(require.main.filename),t=path.join(t,(e||"/ui").replace("/",""));if(!fs.existsSync(t))throw new Error("UI directory not found at "+t);if(fs.readdirSync(t).length)return getFileTree(t);throw new Error("No files found in UI directory at "+t)}const ALLOWED_FILE_EXTENSIONS=[".js",".ts"],ALLOWED_FILE_NAMES=["ui","error","notFound","gate"],EXCLUEDED_DIRECTORIES_REGEX=[/^_.*$/,/^\(.*$/],getFileTree=(i,e=0)=>{const c=[];return fs.readdirSync(i).forEach(t=>{var o=path.join(i,t),e=path.join("",t),r=fs.statSync(o),n={path:o,route:e,isDirectory:r.isDirectory(),children:[],component:void 0};if(r.isDirectory())EXCLUEDED_DIRECTORIES_REGEX.some(e=>e.test(t))||(n.children=getFileTree(o,e),c.push(n));else{var r=path.extname(t),a=path.basename(t,r);if(ALLOWED_FILE_EXTENSIONS.includes(r)&&ALLOWED_FILE_NAMES.includes(a))try{var s=require(o);n.component=s?.default||s||void 0,n.route=e.replace(r,""),n.component&&"function"==typeof n.component&&c.push(n)}catch(e){throw new Error(`Error loading file ${o}: `+e.message)}}}),c},maxLength=100,uuidLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/uuid"),routeLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/route");function encodeRoute(e,t){let o=""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}r`+ARGS_DIVIDER+e;var r;return o.length>maxLength&&(r=routeLocalStorage.getItem(o),o=r?""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+r:(r=uuid.v4(),routeLocalStorage.setItem(o,r),uuidLocalStorage.setItem(r,e),""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+r)),o}function getRouteFromUUID(e){return uuidLocalStorage.getItem(e)}function gateErrorPage({interaction:e,ButtonBuilder:t,render:o,pathname:r}){e&&o&&t&&(e=(new t).setStyle(discordjs.ButtonStyle.Secondary).setLabel("🔄️").navigateTo(r),o({components:[(new discordjs.ActionRowBuilder).addComponents(e)],embeds:[(new discordjs.EmbedBuilder).setTitle("Disallowed").setDescription("You are not allowed to go here").setColor("#68398f")]}))}function errorPage({interaction:e,ButtonBuilder:t,render:o,pathname:r}){e&&o&&t&&(e=(new t).setStyle(discordjs.ButtonStyle.Secondary).setLabel("🔄️").navigateTo(r),o({components:[(new discordjs.ActionRowBuilder).addComponents(e)],embeds:[(new discordjs.EmbedBuilder).setTitle("Error").setDescription("An error occurred.").setColor("#880000")]}))}function notFoundPage({interaction:e,ButtonBuilder:t,render:o,pathname:r}){e&&o&&t&&(e=(new t).setStyle(discordjs.ButtonStyle.Secondary).setLabel("🔄️").navigateTo(r),o({components:[(new discordjs.ActionRowBuilder).addComponents(e)],embeds:[(new discordjs.EmbedBuilder).setTitle("Not Found").setDescription("**404** - Page not found").setColor("#63a8f7")]}))}function getUIFnAndRouteNameAndParams(e,t){const s={};let i="/";var o=new URL("https://lol.lol"+decodeURI(e));e=o.pathname;const r={};o.searchParams.forEach((e,t)=>{r[t]=e});var c=t;const u=e.split("/");""===u[0]&&u.shift();let l=!1,n=null,a={route:"error",component:errorPage,children:[],isDirectory:!1},d={route:"notFound",component:notFoundPage,children:[],isDirectory:!1},m=[],h={route:"gateError",component:gateErrorPage,children:[],isDirectory:!1};function f(e){e.forEach(e=>{e.isDirectory||("error"===e.route?a=e:"notFound"===e.route?d=e:"gateError"===e.route?h=e:"gate"===e.route?m.push(e):"ui"===e.route&&(n=e))})}return f(c),u.forEach((o,r)=>{if(!l){let t=!1;for(let e=0;e<c.length;e++){var n,a=c[e];if(a.isDirectory){if(a.route===o)return i+="/"+o,f(c=a.children),t=!0;if(/\[\.\.\..*\]/g.test(a.route)&&(n=a.route.replace("[","").replace(".","").replace(".","").replace(".","").replace("]",""),s[n]=u.slice(r).join("/"),i+="/:..."+n,f(a.children),e=c.length),/\[.*\]/g.test(a.route))return n=a.route.replace("[","").replace("]",""),s[n]=decodeURI(o),i+="/:"+o,f(c=a.children),t=!0}}t||(l=!0)}}),!l&&n||(console.log("Route not found ("+e+")"),l=!0),"function"!=typeof n?.component&&(console.error("Component is not a function ("+e+")"),l=!0),{uiRoute:n,errorRoute:a,notFoundRoute:d,gateRoutes:m,gateErrorRoute:h,routeName:i,params:s,searchParams:r,notFound:l,cleanPathname:decodeURI(e)}}function getNewPathNameWithSearchParams(e,t){var o;return t?((o=new URL("https://lol.lol"+decodeURI(e))).search=new URLSearchParams(t).toString(),o.pathname+o.search):e}function createRegisterSlashCommandsFunction(e){const{clientId:r,token:n,guildId:a}=e;return async e=>{var t=(new discordjs.REST).setToken(n);try{console.log("Started refreshing application (/) commands.");var o=e?.map(e=>e?.command?.toJSON())?.filter(e=>e)||[];await t.put(a?discordjs.Routes.applicationGuildCommands(r,a):discordjs.Routes.applicationCommands(r),{body:o}),console.log("Successfully reloaded application (/) commands.")}catch(e){console.error(e)}}}const contexts=new Map,asyncHook=async_hooks.createHook({init(e,t,o){contexts.has(o)&&contexts.set(e,contexts.get(o))},destroy(e){contexts.delete(e)}}),setContext=(asyncHook.enable(),e=>{contexts.set(async_hooks.executionAsyncId(),e)}),getContext=()=>{var e=contexts.get(async_hooks.executionAsyncId());if(e)return e;throw new Error("Cant use this function outside of a discordjs-ui route")},runWithContext=(e,t)=>new async_hooks.AsyncResource("RunWithContext").runInAsyncScope(async()=>{setContext(e),await t()});async function render(e){var t=getContext()["interaction"];try{t?.deffered||t?.replied?await t?.editReply?.(e):t?.message?await t?.update?.(e):await t?.reply?.(e)}catch(e){console.error(e)}}async function deferRender(){var e=getContext()["interaction"];try{e?.deffered||e?.replied||(e?.message?await e?.deferUpdate?.():await e?.deferReply?.())}catch(e){console.error(e)}}var __classPrivateFieldGet$1=function(e,t,o,r){if("a"===o&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e===t&&r:t.has(e))return"m"===o?r:"a"===o?r.call(e):r?r.value:t.get(e);throw new TypeError("Cannot read private member from an object whose class did not declare it")};class ButtonBuilder extends discordjs.ButtonBuilder{constructor(){super(),_ButtonBuilder_instances.add(this)}navigateTo(e,t){var o=getContext()["prefix"];return e=getNewPathNameWithSearchParams(e,t?.searchParams),__classPrivateFieldGet$1(this,_ButtonBuilder_instances,"m",_ButtonBuilder_setCustomId).call(this,encodeRoute(e,o)),this.setCustomId=null,this}onClick(e,t){var{prefix:o,buttonCache:r,currentPathname:n}=getContext();if(!t)throw new Error("onClick requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory.");o=o.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<o+t.length)throw new Error(`Key is too long (max: ${100-o}).`);return r.set(t,e,n),__classPrivateFieldGet$1(this,_ButtonBuilder_instances,"m",_ButtonBuilder_setCustomId).call(this,t),this.setCustomId=null,this}}async function navigate(g,p={}){const{routes:w,interaction:R,globalMetadata:I,prefix:e,buttonCache:t}=getContext();runWithContext({routes:w,interaction:R,globalMetadata:I,prefix:e,buttonCache:t,currentPathname:g},async()=>{if(!p.blank){var{uiRoute:t,errorRoute:o,gateRoutes:r,notFoundRoute:n,routeName:a,params:s,searchParams:i,cleanPathname:c,notFound:u}=getUIFnAndRouteNameAndParams(g=getNewPathNameWithSearchParams(g,p?.searchParams),w);let e=null;if(R?.fields?.fields){e={};for(const f of R.fields.fields.keys())e[f]=R.fields.fields.get(f)?.value||null}var l,d,m={interaction:R,pathname:c||null,route:a,params:s,searchParams:i,globalMetadata:I,modal:e};try{if(u)(l=await n?.component?.(m))&&render(l);else{for(let e=0;e<r.length;e++){var h=r[e];if(h.component)if(!await h.component(m))return}"ui"===t?.route&&(d=await t?.component?.(m))&&render(d)}}catch(e){console.log(e.message);c=await o?.component?.(m);c&&render(c)}}})}var _ModalBuilder_instances,_ModalBuilder_setCustomId,_ButtonBuilder_instances=new WeakSet,_ButtonBuilder_setCustomId=function(e){if(this.setCustomId)return this.setCustomId(e),this;throw new Error("Use only one of navigateTo or onClick methods.")},__classPrivateFieldGet=function(e,t,o,r){if("a"===o&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e===t&&r:t.has(e))return"m"===o?r:"a"===o?r.call(e):r?r.value:t.get(e);throw new TypeError("Cannot read private member from an object whose class did not declare it")};class ModalBuilder extends discordjs.ModalBuilder{constructor(){super(),_ModalBuilder_instances.add(this)}navigateTo(e,t){var o=getContext()["prefix"];return e=getNewPathNameWithSearchParams(e,t?.searchParams),__classPrivateFieldGet(this,_ModalBuilder_instances,"m",_ModalBuilder_setCustomId).call(this,encodeRoute(e,o)),this.setCustomId=null,this}onSubmit(e,t){var{prefix:o,buttonCache:r,currentPathname:n}=getContext();if(!t)throw new Error("onSubmit requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory.");o=o.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<o+t.length)throw new Error(`Key is too long (max: ${100-o}).`);return r.set(t,e,n),__classPrivateFieldGet(this,_ModalBuilder_instances,"m",_ModalBuilder_setCustomId).call(this,t),this.setCustomId=null,this}}async function reply(e){var t=getContext()["interaction"];t?.replied?await t?.followUp?.(e):await t?.reply?.(e)}function createUI(e){const{prefix:h="ui",routeDirectory:t="/ui",customRoutes:o=null,useFunctionalButtons:f=!1,functionalButtonTtl:r=1800,globalMetadata:g,slashCommands:p=[],slashCommandRegisterFunction:n=null}=e||{};if(0<p.length&&!n)throw new Error("slashCommandRegisterFunction is required when slashCommands are provided");if(h.length>PREFIX_LENGTH)throw new Error("Prefix length cannot be more than 12 characters");if(h.includes(ARGS_DIVIDER))throw new Error(`Prefix cannot contain '${ARGS_DIVIDER}' character`);n&&0<p?.length&&n(p);const w=o?getRoutesFromCustomRoutes(o):getRoutesFromDirectory(t),R=createButtonCache(r);async function I(e,t){runWithContext({routes:w,interaction:e,globalMetadata:g,prefix:h,buttonCache:R},async()=>{await navigate(t)})}return{openUI:I,onInteraction:function(m){runWithContext({routes:w,interaction:m,globalMetadata:g,prefix:h,buttonCache:R},async()=>{if(m?.isChatInputCommand()){const l=m["commandName"];var e=p.find(e=>e?.command?.name===l);e&&(e=(e||{})["navigateTo"],e)&&I(m,e)}else if(m?.isButton()||m?.isModalSubmit()){var{customId:e=""}=m||{};if(e?.startsWith(h+ARGS_DIVIDER)){var t,o,r,n,[e,a,...s]=e.split(ARGS_DIVIDER);if(e===h){let e=null;if(m?.fields?.fields){e={};for(const d of m.fields.fields.keys())e[d]=m.fields.fields.get(d)?.value||null}switch(a){case"n":var[i,c]=s;switch(i){case"c":var u=getRouteFromUUID(c);if(!u)return;navigate(u);break;case"r":navigate(c)}break;case"f":f&&([i]=s,{routeName:t,params:o,searchParams:r,cleanPathname:n}=getUIFnAndRouteNameAndParams((i=R.get(i)).currentPathname,w),n={pathname:n||null,route:t,params:o,searchParams:r,interaction:m,globalMetadata:g,modal:e},i?.fn?.(n))}}}}})}}}_ModalBuilder_instances=new WeakSet,_ModalBuilder_setCustomId=function(e){if(this.setCustomId)return this.setCustomId(e),this;throw new Error("Use only one of navigateTo or onClick methods.")};const setupFunctions={createUI:createUI,createRegisterSlashCommandsFunction:createRegisterSlashCommandsFunction},routeFunctions={render:render,reply:reply,deferRender:deferRender,navigate:navigate},builders={ButtonBuilder:ButtonBuilder,ModalBuilder:ModalBuilder},discordjsUI={...discordjs__namespace,...setupFunctions,...routeFunctions,...builders};module.exports=discordjsUI;