"use strict";var uuid=require("uuid"),nodeLocalstorage=require("node-localstorage"),discord_js=require("discord.js");function createButtonCache(a){const n=new Map;return setInterval(()=>{var e,t,r=Date.now();for([e,t]of n)t.ttl<r&&n.delete(e)},1e3),{set:function(e,t,r){t={fn:t,ttl:Date.now()+1e3*a,currentPathname:r},n.set(e,t)},get:function(e){return n.get(e)}}}const ARGS_DIVIDER=">",PREFIX_LENGTH=12,fs=require("fs"),path=require("path");function getRoutesFromCustomRoutes(e=[]){return e.forEach(e=>{removeFirstLastSlash(e.route).split("/")}),[]}function removeFirstLastSlash(e){return e.replace(/^\/|\/$/g,"")}function getRoutesFromDirectory(e){var t=path.dirname(require.main.filename),t=path.join(t,(e||"/ui").replace("/",""));if(!fs.existsSync(t))throw new Error("UI directory not found at "+t);if(fs.readdirSync(t).length)return getFileTree(t);throw new Error("No files found in UI directory at "+t)}const ALLOWED_FILE_EXTENSIONS=[".js",".ts"],ALLOWED_FILE_NAMES=["ui","route"],EXCLUEDED_DIRECTORIES_REGEX=[/^_.*$/,/^\(.*$/],getFileTree=(s,e=0)=>{const c=[];return fs.readdirSync(s).forEach(t=>{var r=path.join(s,t),e=path.join("",t),a=fs.statSync(r),n={path:r,route:e,isDirectory:a.isDirectory(),children:[],component:void 0};if(a.isDirectory())EXCLUEDED_DIRECTORIES_REGEX.some(e=>e.test(t))||(n.children=getFileTree(r,e),c.push(n));else{var a=path.extname(t),o=path.basename(t,a);if(ALLOWED_FILE_EXTENSIONS.includes(a)&&ALLOWED_FILE_NAMES.includes(o))try{var i=require(r);n.component=i?.default||i||void 0,n.route=e.replace(a,""),n.component&&"function"==typeof n.component&&c.push(n)}catch(e){throw new Error(`Error loading file ${r}: `+e.message)}}}),c},maxLength=100,uuidLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/uuid"),routeLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/route");function encodeRoute(e,t){let r=""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}r`+ARGS_DIVIDER+e;var a;return r.length>maxLength&&(a=routeLocalStorage.getItem(r),r=a?""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+a:(a=uuid.v4(),routeLocalStorage.setItem(r,a),uuidLocalStorage.setItem(a,e),""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+a)),r}function getRouteFromUUID(e){return uuidLocalStorage.getItem(e)}const ERROR_SUFFIX=" (UIButtonBuilder)";function getBuilders(l,d,m){return{UIButtonBuilder:class{constructor(){this.button={type:2,style:1,label:"",disabled:!1,emoji:null,url:null,custom_id:null,onClick:null,navigateTo:null},this.onClickKey=null}setLabel(e){return this.button.label=e,this}setStyle(e){return this.button.style=e,this}setEmoji(e){return this.button.emoji=e,this}setUrl(e){return this.button.url=e,this}setDisabled(e){return this.button.disabled=e,this}onClick(e,t){if(!t)throw new Error("onClick requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory"+ERROR_SUFFIX);var r=l.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<r+t.length)throw new Error(`Key is too long (max: ${100-r})`+ERROR_SUFFIX);return this.button.onClick=e,this.onClickKey=t,this}navigateTo(e,t){return e=getNewPathNameWithSearchParams(e,t?.searchParams),this.button.navigateTo=encodeURI(e),this}setCustomId(e){return this.button.custom_id=e,this}build(){var{custom_id:e,label:t,style:r,emoji:a,disabled:n,navigateTo:o,onClick:i,url:s}=this.button||{};if(!t)throw new Error("Label is required"+ERROR_SUFFIX);if(!r)throw new Error("Style is required"+ERROR_SUFFIX);var c=new discord_js.ButtonBuilder;a&&c.setEmoji(a),r&&c.setStyle(r),t&&c.setLabel(t),s&&c.setURL(s),n&&c.setDisabled(n);let u=e;return i?(a=this.onClickKey,d.set(a,i,m)):o&&(u=encodeRoute(o,l)),c.setCustomId(u),c}}}}function createUIRender(r){return{render:async function(e,t=0){try{r?.deffered||r?.replied?await r?.editReply?.(e):r?.message?await r?.update?.(e):await r?.reply?.(e)}catch(e){console.error(e)}},deferRender:async function(){try{r?.message?await r?.deferUpdate?.():await r?.deferReply?.()}catch(e){console.error(e)}}}}function createNavigation(u,l,d,e,m="ui",h){return{navigate:function e(t,r={}){var a,n,o,i,s,c=getBuilders(m,h,t).UIButtonBuilder;r.blank||({uiFn:r,routeName:t,params:a,searchParams:n,cleanPathname:o}=getUIFnAndRouteNameAndParams(t=getNewPathNameWithSearchParams(t,r?.searchParams),u),{render:i,deferRender:s}=createUIRender(l),"ui"===r?.route?r?.component?.({interaction:l,navigate:e,pathname:o||null,route:t,params:a,searchParams:n,globalMetadata:d,UIButtonBuilder:c,render:i,deferRender:s}):"route"===r?.route&&r?.component?.({navigate:e,pathname:o||null,route:t,params:a,searchParams:n,globalMetadata:d}))}}}function getUIFnAndRouteNameAndParams(e,t){const i={};let s="/";var r=new URL("https://lol.lol"+decodeURI(e));e=r.pathname;const a={};r.searchParams.forEach((e,t)=>{a[t]=e});var c=t;const u=e.split("/");""===u[0]&&u.shift();let l=!1;u.forEach((r,a)=>{if(!l){let t=!1;for(let e=0;e<c.length;e++){var n,o=c[e];if(o.isDirectory){if(o.route===r)return s+="/"+r,c=o.children,t=!0;if(/\[\.\.\..*\]/g.test(o.route)&&(n=o.route.replace("[","").replace(".","").replace(".","").replace(".","").replace("]",""),i[n]=u.slice(a).join("/"),s+="/:..."+n,e=c.length),/\[.*\]/g.test(o.route))return n=o.route.replace("[","").replace("]",""),i[n]=decodeURI(r),s+="/:"+r,c=o.children,t=!0}}t||(l=!0)}});r=c.find(e=>!1===e.isDirectory);return l||!r?(console.log("Route not found ("+e+")"),{}):"function"!=typeof r.component?(console.error("Component is not a function ("+e+")"),{}):{uiFn:r,routeName:s,params:i,searchParams:a,cleanPathname:decodeURI(e)}}function getNewPathNameWithSearchParams(e,t){var r;return t?((r=new URL("https://lol.lol"+decodeURI(e))).search=new URLSearchParams(t).toString(),r.pathname+r.search):e}function createRegisterSlashCommandsFunction(e){const{clientId:a,token:n,guildId:o}=e;return async e=>{var t=(new discord_js.REST).setToken(n);try{console.log("Started refreshing application (/) commands.");var r=e?.map(e=>e?.command?.toJSON())?.filter(e=>e)||[];await t.put(o?discord_js.Routes.applicationGuildCommands(a,o):discord_js.Routes.applicationCommands(a),{body:r}),console.log("Successfully reloaded application (/) commands.")}catch(e){console.error(e)}}}function createUI(e){const{prefix:g="ui",routeDirectory:t="/ui",customRoutes:r=null,useFunctionalButtons:I=!1,functionalButtonTtl:a=1800,globalMetadata:p,messageDefault:E={},slashCommands:S=[],slashCommandRegisterFunction:n=null}=e||{};if(0<S.length&&!n)throw new Error("slashCommandRegisterFunction is required when slashCommands are provided");if(g.length>PREFIX_LENGTH)throw new Error("Prefix length cannot be more than 12 characters");if(g.includes(ARGS_DIVIDER))throw new Error(`Prefix cannot contain '${ARGS_DIVIDER}' character`);n&&0<S?.length&&n(S);const D=r?getRoutesFromCustomRoutes(r):getRoutesFromDirectory(t),v=createButtonCache(a);async function w(e,t){e=createNavigation(D,e,p).navigate;e(t)}return{openUI:w,onInteraction:function(e){if(e?.isChatInputCommand()){const f=e["commandName"];var t=S.find(e=>e?.command?.name===f);t&&(t=(t||{})["navigateTo"],t)&&w(e,t)}else if(e?.isButton()){var{customId:t=""}=e||{};if(t?.startsWith(g+ARGS_DIVIDER)){var[t,r,...a]=t.split(ARGS_DIVIDER);if(t===g){var n,o,i,s,c=getBuilders(g,v,"")["UIButtonBuilder"],{render:u,deferRender:l}=createUIRender(e),d=createNavigation(D,e,p,E,g,v)["navigate"];switch(r){case"n":var[m,h]=a;switch(m){case"c":var R=getRouteFromUUID(h);if(!R)return;d(R);break;case"r":d(h)}break;case"f":I&&([m]=a,{routeName:n,params:o,searchParams:i,cleanPathname:s}=getUIFnAndRouteNameAndParams((m=v.get(m)).currentPathname,D),s={pathname:s||null,route:n,params:o,searchParams:i,interaction:e,navigate:d,UIButtonBuilder:c,globalMetadata:p,render:u,deferRender:l},m?.fn?.(s))}}}}}}}exports.createRegisterSlashCommandsFunction=createRegisterSlashCommandsFunction,exports.createUI=createUI;