"use strict";var uuid=require("uuid"),nodeLocalstorage=require("node-localstorage"),discord_js=require("discord.js");function createButtonCache(o){const n=new Map;return setInterval(()=>{var e,t,r=Date.now();for([e,t]of n)t.ttl<r&&n.delete(e)},1e3),{set:function(e,t,r){t={fn:t,ttl:Date.now()+1e3*o,currentPathname:r},n.set(e,t)},get:function(e){return n.get(e)}}}const ARGS_DIVIDER=">",PREFIX_LENGTH=12,fs=require("fs"),path=require("path");function getRoutesFromCustomRoutes(e=[]){return e.forEach(e=>{removeFirstLastSlash(e.route).split("/")}),[]}function removeFirstLastSlash(e){return e.replace(/^\/|\/$/g,"")}function getRoutesFromDirectory(e){var t=path.dirname(require.main.filename),t=path.join(t,(e||"/ui").replace("/",""));if(!fs.existsSync(t))throw new Error("UI directory not found at "+t);if(fs.readdirSync(t).length)return getFileTree(t);throw new Error("No files found in UI directory at "+t)}const ALLOWED_FILE_EXTENSIONS=[".js",".ts"],ALLOWED_FILE_NAMES=["ui","error","notFound","check","checkFail","loading"],EXCLUEDED_DIRECTORIES_REGEX=[/^_.*$/,/^\(.*$/],getFileTree=(s,e=0)=>{const c=[];return fs.readdirSync(s).forEach(t=>{var r=path.join(s,t),e=path.join("",t),o=fs.statSync(r),n={path:r,route:e,isDirectory:o.isDirectory(),children:[],component:void 0};if(o.isDirectory())EXCLUEDED_DIRECTORIES_REGEX.some(e=>e.test(t))||(n.children=getFileTree(r,e),c.push(n));else{var o=path.extname(t),a=path.basename(t,o);if(ALLOWED_FILE_EXTENSIONS.includes(o)&&ALLOWED_FILE_NAMES.includes(a))try{var i=require(r);n.component=i?.default||i||void 0,n.route=e.replace(o,""),n.component&&"function"==typeof n.component&&c.push(n)}catch(e){throw new Error(`Error loading file ${r}: `+e.message)}}}),c},maxLength=100,uuidLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/uuid"),routeLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/route");function encodeRoute(e,t){let r=""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}r`+ARGS_DIVIDER+e;var o;return r.length>maxLength&&(o=routeLocalStorage.getItem(r),r=o?""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+o:(o=uuid.v4(),routeLocalStorage.setItem(r,o),uuidLocalStorage.setItem(o,e),""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+o)),r}function getRouteFromUUID(e){return uuidLocalStorage.getItem(e)}function checkFailPage({interaction:e,ButtonBuilder:t,render:r,pathname:o}){e&&r&&t&&(e=(new t).setStyle(discord_js.ButtonStyle.Secondary).setLabel("üîÑÔ∏è").navigateTo(o),r({components:[(new discord_js.ActionRowBuilder).addComponents(e)],embeds:[(new discord_js.EmbedBuilder).setTitle("Disallowed").setDescription("You are not allowed to go here").setColor("#68398f")]}))}function errorPage({interaction:e,ButtonBuilder:t,render:r,pathname:o}){e&&r&&t&&(e=(new t).setStyle(discord_js.ButtonStyle.Secondary).setLabel("üîÑÔ∏è").navigateTo(o),r({components:[(new discord_js.ActionRowBuilder).addComponents(e)],embeds:[(new discord_js.EmbedBuilder).setTitle("Error").setDescription("An error occurred.").setColor("#880000")]}))}function notFoundPage({interaction:e,ButtonBuilder:t,render:r,pathname:o}){e&&r&&t&&(e=(new t).setStyle(discord_js.ButtonStyle.Secondary).setLabel("üîÑÔ∏è").navigateTo(o),r({components:[(new discord_js.ActionRowBuilder).addComponents(e)],embeds:[(new discord_js.EmbedBuilder).setTitle("Not Found").setDescription("**404** - Page not found").setColor("#63a8f7")]}))}var __classPrivateFieldGet=function(e,t,r,o){if("a"===r&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e===t&&o:t.has(e))return"m"===r?o:"a"===r?o.call(e):o?o.value:t.get(e);throw new TypeError("Cannot read private member from an object whose class did not declare it")};function getBuilders(o,n,a){var i,s;class e extends discord_js.ButtonBuilder{constructor(){super(),i.add(this)}navigateTo(e,t){return e=getNewPathNameWithSearchParams(e,t?.searchParams),__classPrivateFieldGet(this,i,"m",s).call(this,encodeRoute(e,o)),this.setCustomId=null,this}onClick(e,t){if(!t)throw new Error("onClick requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory.");var r=o.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<r+t.length)throw new Error(`Key is too long (max: ${100-r}).`);return n.set(t,e,a),__classPrivateFieldGet(this,i,"m",s).call(this,t),this.setCustomId=null,this}}return i=new WeakSet,s=function(e){if(this.setCustomId)return this.setCustomId(e),this;throw new Error("Use only one of navigateTo or onClick methods.")},{ButtonBuilder:e}}function createUIRender(r){return{render:async function(e,t=0){try{r?.deffered||r?.replied?await r?.editReply?.(e):r?.message?await r?.update?.(e):await r?.reply?.(e)}catch(e){console.error(e)}},deferRender:async function(){try{r?.deffered||r?.replied||(r?.message?await r?.deferUpdate?.():await r?.deferReply?.())}catch(e){console.error(e)}}}}function createNavigation(S,v,y,e,_="ui",F){return{navigate:async function e(t,r={}){var o=getBuilders(_,F,t).ButtonBuilder;if(!r.blank){var n,a,i,{uiRoute:r,errorRoute:t,checkFailRoute:s,checkRoutes:c,notFoundRoute:u,loadingRoute:l,routeName:d,params:m,searchParams:h,cleanPathname:f,notFound:g}=getUIFnAndRouteNameAndParams(t=getNewPathNameWithSearchParams(t,r?.searchParams),S),{render:p,deferRender:R}=createUIRender(v),I={interaction:v,navigate:e,pathname:f||null,route:d,params:m,searchParams:h,globalMetadata:y,ButtonBuilder:o,render:p,deferRender:R},E={interaction:v,pathname:f,route:d,params:m,searchParams:h,globalMetadata:y};try{if(l&&(n=await l?.component?.(I))&&p(n),g)(a=await u?.component?.(I))&&p(a);else{for(let e=0;e<c.length;e++){var w,D=c[e];if(D.component&&!D.component(E))return void((w=await s?.component?.(I))&&p(w))}"ui"===r?.route&&(i=await r?.component?.(I))&&p(i)}}catch(e){console.log(e.message),(o=await t?.component?.(I))&&p(o)}}}}}function getUIFnAndRouteNameAndParams(e,t){const i={};let s="/";var r=new URL("https://lol.lol"+decodeURI(e));e=r.pathname;const o={};r.searchParams.forEach((e,t)=>{o[t]=e});var c=t;const u=e.split("/");""===u[0]&&u.shift();let l=!1,n=null,a=null,d={route:"error",component:errorPage,children:[],isDirectory:!1},m={route:"notFound",component:notFoundPage,children:[],isDirectory:!1},h=[],f={route:"checkFail",component:checkFailPage,children:[],isDirectory:!1};function g(e){e.forEach(e=>{e.isDirectory||("error"===e.route?d=e:"notFound"===e.route?m=e:"checkFail"===e.route?f=e:"check"===e.route?h.push(e):"ui"===e.route?n=e:"loading"===e.route&&(a=e))})}return g(c),u.forEach((r,o)=>{if(!l){let t=!1;for(let e=0;e<c.length;e++){var n,a=c[e];if(a.isDirectory){if(a.route===r)return s+="/"+r,g(c=a.children),t=!0;if(/\[\.\.\..*\]/g.test(a.route)&&(n=a.route.replace("[","").replace(".","").replace(".","").replace(".","").replace("]",""),i[n]=u.slice(o).join("/"),s+="/:..."+n,g(a.children),e=c.length),/\[.*\]/g.test(a.route))return n=a.route.replace("[","").replace("]",""),i[n]=decodeURI(r),s+="/:"+r,g(c=a.children),t=!0}}t||(l=!0)}}),!l&&n||(console.log("Route not found ("+e+")"),l=!0),"function"!=typeof n?.component&&(console.error("Component is not a function ("+e+")"),l=!0),{uiRoute:n,errorRoute:d,notFoundRoute:m,checkRoutes:h,checkFailRoute:f,loadingRoute:a,routeName:s,params:i,searchParams:o,notFound:l,cleanPathname:decodeURI(e)}}function getNewPathNameWithSearchParams(e,t){var r;return t?((r=new URL("https://lol.lol"+decodeURI(e))).search=new URLSearchParams(t).toString(),r.pathname+r.search):e}function createRegisterSlashCommandsFunction(e){const{clientId:o,token:n,guildId:a}=e;return async e=>{var t=(new discord_js.REST).setToken(n);try{console.log("Started refreshing application (/) commands.");var r=e?.map(e=>e?.command?.toJSON())?.filter(e=>e)||[];await t.put(a?discord_js.Routes.applicationGuildCommands(o,a):discord_js.Routes.applicationCommands(o),{body:r}),console.log("Successfully reloaded application (/) commands.")}catch(e){console.error(e)}}}function createUI(e){const{prefix:p="ui",routeDirectory:t="/ui",customRoutes:r=null,useFunctionalButtons:R=!1,functionalButtonTtl:o=1800,globalMetadata:I,messageDefault:E={},slashCommands:w=[],slashCommandRegisterFunction:n=null}=e||{};if(0<w.length&&!n)throw new Error("slashCommandRegisterFunction is required when slashCommands are provided");if(p.length>PREFIX_LENGTH)throw new Error("Prefix length cannot be more than 12 characters");if(p.includes(ARGS_DIVIDER))throw new Error(`Prefix cannot contain '${ARGS_DIVIDER}' character`);n&&0<w?.length&&n(w);const D=r?getRoutesFromCustomRoutes(r):getRoutesFromDirectory(t),S=createButtonCache(o);async function v(e,t){e=createNavigation(D,e,I).navigate;e(t)}return{openUI:v,onInteraction:function(e){if(e?.isChatInputCommand()){const g=e["commandName"];var t=w.find(e=>e?.command?.name===g);t&&(t=(t||{})["navigateTo"],t)&&v(e,t)}else if(e?.isButton()){var{customId:t=""}=e||{};if(t?.startsWith(p+ARGS_DIVIDER)){var[t,r,...o]=t.split(ARGS_DIVIDER);if(t===p){var n,a,i,s,c=getBuilders(p,S,"")["ButtonBuilder"],{render:u,deferRender:l}=(console.log("ButtonBuilder",c),createUIRender(e)),d=createNavigation(D,e,I,E,p,S)["navigate"];switch(r){case"n":var[m,h]=o;switch(m){case"c":var f=getRouteFromUUID(h);if(!f)return;d(f);break;case"r":d(h)}break;case"f":R&&([m]=o,{routeName:n,params:a,searchParams:i,cleanPathname:s}=getUIFnAndRouteNameAndParams((m=S.get(m)).currentPathname,D),s={pathname:s||null,route:n,params:a,searchParams:i,interaction:e,navigate:d,ButtonBuilder:c,globalMetadata:I,render:u,deferRender:l},m?.fn?.(s))}}}}}}}exports.createRegisterSlashCommandsFunction=createRegisterSlashCommandsFunction,exports.createUI=createUI;