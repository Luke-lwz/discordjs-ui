"use strict";var uuid=require("uuid"),nodeLocalstorage=require("node-localstorage"),discordjs=require("discord.js"),async_hooks=require("async_hooks");function _interopNamespaceDefault(o){var n=Object.create(null);return o&&Object.keys(o).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(o,e),Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return o[e]}}))}),n.default=o,Object.freeze(n)}var discordjs__namespace=_interopNamespaceDefault(discordjs);function createButtonCache(n){const r=new Map;return setInterval(()=>{var e,t,o=Date.now();for([e,t]of r)t.ttl<o&&r.delete(e)},1e3),{set:function(e,t,o){t={fn:t,ttl:Date.now()+1e3*n,currentPathname:o},r.set(e,t)},get:function(e){return r.get(e)}}}const ARGS_DIVIDER=">",PREFIX_LENGTH=12,fs=require("fs"),path=require("path");function getRoutesFromCustomRoutes(e=[]){return e.forEach(e=>{removeFirstLastSlash(e.route).split("/")}),[]}function removeFirstLastSlash(e){return e.replace(/^\/|\/$/g,"")}function getRoutesFromDirectory(e){var t=path.dirname(require.main.filename),t=path.join(t,(e||"/ui").replace("/",""));if(!fs.existsSync(t))throw new Error("UI directory not found at "+t);if(fs.readdirSync(t).length)return getFileTree(t);throw new Error("No files found in UI directory at "+t)}const ALLOWED_FILE_EXTENSIONS=[".js",".ts"],ALLOWED_FILE_NAMES=["ui","error","notFound","gate","messageLayout","context"],EXCLUEDED_DIRECTORIES_REGEX=[/^_.*$/,/^\(.*$/],getFileTree=(i,e=0)=>{const c=[];return fs.readdirSync(i).forEach(t=>{var o=path.join(i,t),e=path.join("",t),n=fs.statSync(o),r={path:o,route:e,isDirectory:n.isDirectory(),children:[],component:void 0};if(n.isDirectory())EXCLUEDED_DIRECTORIES_REGEX.some(e=>e.test(t))||(r.children=getFileTree(o,e),c.push(r));else{var n=path.extname(t),a=path.basename(t,n);if(ALLOWED_FILE_EXTENSIONS.includes(n)&&ALLOWED_FILE_NAMES.includes(a))try{var s=require(o);r.component=s?.default||s||void 0,r.route=e.replace(n,""),r.component&&"function"==typeof r.component&&c.push(r)}catch(e){throw new Error(`Error loading file ${o}: `+e.message)}}}),c},maxLength=100,uuidLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/uuid"),routeLocalStorage=new nodeLocalstorage.LocalStorage("./discordjs-ui/localStorage/routes/route");function encodeRoute(e,t){let o=""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}r`+ARGS_DIVIDER+e;var n;return o.length>maxLength&&(n=routeLocalStorage.getItem(o),o=n?""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+n:(n=uuid.v4(),routeLocalStorage.setItem(o,n),uuidLocalStorage.setItem(n,e),""+t+ARGS_DIVIDER+`n${ARGS_DIVIDER}c`+ARGS_DIVIDER+n)),o}function getRouteFromUUID(e){return uuidLocalStorage.getItem(e)}function errorPage({interaction:e,ButtonBuilder:t,render:o,pathname:n}){e&&o&&t&&(e=(new t).setStyle(discordjs.ButtonStyle.Secondary).setLabel("🔄️").navigateTo(n),o({components:[(new discordjs.ActionRowBuilder).addComponents(e)],embeds:[(new discordjs.EmbedBuilder).setTitle("Error").setDescription("An error occurred.").setColor("#880000")]}))}function notFoundPage({interaction:e,ButtonBuilder:t,render:o,pathname:n}){e&&o&&t&&(e=(new t).setStyle(discordjs.ButtonStyle.Secondary).setLabel("🔄️").navigateTo(n),o({components:[(new discordjs.ActionRowBuilder).addComponents(e)],embeds:[(new discordjs.EmbedBuilder).setTitle("Not Found").setDescription("**404** - Page not found").setColor("#63a8f7")]}))}function getUIFnAndRouteNameAndParams(e,t){const s={};let i="/";var o=new URL("https://lol.lol"+decodeURI(e));e=o.pathname;const n={};o.searchParams.forEach((e,t)=>{n[t]=e});var c=t;const u=e.split("/");""===u[0]&&u.shift();let l=!1,r=null,a={route:"error",component:errorPage,children:[],isDirectory:!1},d={route:"notFound",component:notFoundPage,children:[],isDirectory:!1},m=[],h=[],f=[];function g(e){e.forEach(e=>{e.isDirectory||("error"===e.route?a=e:"notFound"===e.route?d=e:"gate"===e.route?m.push(e):"messageLayout"===e.route?h.push(e):"context"===e.route?f.push(e):"ui"===e.route&&(r=e))})}return g(c),u.forEach((o,n)=>{if(!l){let t=!1;for(let e=0;e<c.length;e++){var r,a=c[e];if(a.isDirectory){if(a.route===o)return i+="/"+o,g(c=a.children),t=!0;if(/\[\.\.\..*\]/g.test(a.route)&&(r=a.route.replace("[","").replace(".","").replace(".","").replace(".","").replace("]",""),s[r]=u.slice(n).join("/"),i+="/:..."+r,g(a.children),e=c.length),/\[.*\]/g.test(a.route))return r=a.route.replace("[","").replace("]",""),s[r]=decodeURI(o),i+="/:"+o,g(c=a.children),t=!0}}t||(l=!0)}}),!l&&r||(console.log("Route not found ("+e+")"),l=!0),"function"!=typeof r?.component&&(console.error("Component is not a function ("+e+")"),l=!0),{uiRoute:r,errorRoute:a,notFoundRoute:d,gateRoutes:m,messageLayoutRoutes:h,contextRoutes:f,routeName:i,params:s,searchParams:n,notFound:l,cleanPathname:decodeURI(e)}}function getNewPathNameWithSearchParams(e,t){var o;return t?((o=new URL("https://lol.lol"+decodeURI(e))).search=new URLSearchParams(t).toString(),o.pathname+o.search):e}function createRegisterSlashCommandsFunction(e){const{clientId:n,token:r,guildId:a}=e;return async e=>{var t=(new discordjs.REST).setToken(r);try{console.log("Started refreshing application (/) commands.");var o=e?.map(e=>e?.command?.toJSON())?.filter(e=>e)||[];await t.put(a?discordjs.Routes.applicationGuildCommands(n,a):discordjs.Routes.applicationCommands(n),{body:o}),console.log("Successfully reloaded application (/) commands.")}catch(e){console.error(e)}}}const contexts=new Map,asyncHook=async_hooks.createHook({init(e,t,o){contexts.has(o)&&contexts.set(e,contexts.get(o))},destroy(e){contexts.delete(e)}}),setContext=(asyncHook.enable(),e=>{contexts.set(async_hooks.executionAsyncId(),e)}),getContext=(e=!1)=>{var t=contexts.get(async_hooks.executionAsyncId());if(t||e)return t;throw new Error("Cant use this function outside of a discordjs-ui route")},runWithContext=(e,t)=>new async_hooks.AsyncResource("RunWithContext").runInAsyncScope(async()=>{setContext(e),await t()});function mergeLayout(e={},t){var o={...e||{}};for(const n in t)o[n]=t[n];return o}const filesDisallowedToUseRender=["messageLayout","context"];async function render(e){var{interaction:t,fileName:o,messageLayout:n}=getContext();if(filesDisallowedToUseRender.includes(o))throw new Error(`You are not allowed to use render(); in ${o}.`);e=mergeLayout(n,e);let r=null;try{r=t?.deffered||t?.replied?await t?.editReply?.(e):t?.message?await t?.update?.(e):await t?.reply?.(e)}catch(e){console.error(e)}return r}async function deferRender(e){var{interaction:t,fileName:o,messageLayout:n}=getContext();if(filesDisallowedToUseRender.includes(o))throw new Error(`You are not allowed to use deferRender(); in ${o}.`);e=mergeLayout(n,e);let r=null;try{if(t?.deffered||t?.replied)return;r=t?.message?await t?.deferUpdate?.(e):await t?.deferReply?.(e)}catch(e){console.error(e)}return r}var _ButtonBuilder_instances,_ButtonBuilder_setCustomId,__classPrivateFieldGet$1=function(e,t,o,n){if("a"===o&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e===t&&n:t.has(e))return"m"===o?n:"a"===o?n.call(e):n?n.value:t.get(e);throw new TypeError("Cannot read private member from an object whose class did not declare it")};class ButtonBuilder extends discordjs.ButtonBuilder{constructor(){super(),_ButtonBuilder_instances.add(this)}navigateTo(e,t){var o=getContext()["prefix"];return e=getNewPathNameWithSearchParams(e,t?.searchParams),__classPrivateFieldGet$1(this,_ButtonBuilder_instances,"m",_ButtonBuilder_setCustomId).call(this,encodeRoute(e,o)),this.setCustomId=null,this}onClick(e,t){var{prefix:o,buttonCache:n,currentPathname:r}=getContext();if(!t)throw new Error("onClick requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory.");o=o.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<o+t.length)throw new Error(`Key is too long (max: ${100-o}).`);return n.set(t,e,r),__classPrivateFieldGet$1(this,_ButtonBuilder_instances,"m",_ButtonBuilder_setCustomId).call(this,t),this.setCustomId=null,this}}async function reply(e){var{interaction:t,fileName:o,messageLayout:n}=getContext();if(filesDisallowedToUseRender.includes(o))throw new Error(`You are not allowed to use reply(); in ${o}.`);e=mergeLayout(n,e);let r=null;try{r=t?.replied?await t?.followUp?.(e):await t?.reply?.(e)}catch(e){console.error(e)}return r}_ButtonBuilder_instances=new WeakSet,_ButtonBuilder_setCustomId=function(e){if(this.setCustomId)return this.setCustomId(e),this;throw new Error("Use only one of navigateTo or onClick methods.")};const filesDisallowedToUseNavigate=["messageLayout","context"];async function navigate(t,o={}){const n=getContext();var{routes:e,fileName:r}=n;if(filesDisallowedToUseNavigate.includes(r))throw new Error(`You are not allowed to use navigate(); in ${r}.`);const{uiRoute:a,gateRoutes:s,messageLayoutRoutes:i,notFoundRoute:c,notFound:u,contextRoutes:l}=getUIFnAndRouteNameAndParams(t,e);n.messageLayout={};for(let e=0;e<i.length;e++){const m=i[e];m.component&&await contextWrapper(n,t,o,async e=>{e=await m?.component(e);e&&(n.messageLayout=mergeLayout(n.messageLayout,e))},"messageLayout")}n.context={};for(let e=0;e<l.length;e++){const h=l[e];h.component&&await contextWrapper(n,t,o,async e=>{e=await h?.component(e);e&&(n.context=mergeLayout(n.context,e))},"context")}let d=!0;await contextWrapper(n,t,o,async e=>{if(u)return(e=await c?.component?.(e))&&render(e),d=!1},"notFound"),d&&(await contextWrapper(n,t,o,async t=>{for(let e=0;e<s.length;e++){var o=s[e];if(o.component)if(!await o.component(t))return d=!1}},"gate"),d)&&await contextWrapper(n,t,o,async e=>{"ui"===a?.route&&(e=await a?.component?.(e))&&render(e)},"ui")}async function contextWrapper(n,r,e=0,a,t){const{routes:o,interaction:s,globalMetadata:i}=n,{routeName:c,params:u,searchParams:l,cleanPathname:d,errorRoute:m}=getUIFnAndRouteNameAndParams(r,o);await runWithContext({...n,fileName:t,currentPathname:r},async()=>{let e=null;if(s?.fields?.fields){e={};for(const o of s.fields.fields.keys())e[o]=s.fields.fields.get(o)?.value||null}const t={interaction:s,pathname:d||null,route:c,params:u,searchParams:l,globalMetadata:i,context:n.context||{},modal:e};try{await a(t)}catch(e){console.log(e);try{await runWithContext({...n,fileName:"error",currentPathname:r},async()=>{var e=await m?.component?.(t);e&&reply(e)})}catch(e){console.log(e)}}})}var _ModalBuilder_instances,_ModalBuilder_setCustomId,__classPrivateFieldGet=function(e,t,o,n){if("a"===o&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e===t&&n:t.has(e))return"m"===o?n:"a"===o?n.call(e):n?n.value:t.get(e);throw new TypeError("Cannot read private member from an object whose class did not declare it")};class ModalBuilder extends discordjs.ModalBuilder{constructor(){super(),_ModalBuilder_instances.add(this)}navigateTo(e,t){var o=getContext()["prefix"];return e=getNewPathNameWithSearchParams(e,t?.searchParams),__classPrivateFieldGet(this,_ModalBuilder_instances,"m",_ModalBuilder_setCustomId).call(this,encodeRoute(e,o)),this.setCustomId=null,this}onSubmit(e,t){var{prefix:o,buttonCache:n,currentPathname:r}=getContext();if(!t)throw new Error("onSubmit requires 'key' as second argument, for memory management purposes. Two functions with the same key replace each other in memory.");o=o.length+(ARGS_DIVIDER+"f"+ARGS_DIVIDER).length;if(100<o+t.length)throw new Error(`Key is too long (max: ${100-o}).`);return n.set(t,e,r),__classPrivateFieldGet(this,_ModalBuilder_instances,"m",_ModalBuilder_setCustomId).call(this,t),this.setCustomId=null,this}}async function postChannelPrefab(e){const{name:t,type:o,messages:n,guild:r,...a}=e;if(!r)throw new Error("Missing guild in postChannelPrefab");let s=null;var i=[];try{var c=await r.channels.create({name:t,type:o,...a});s=c;for(const l of n){var u=await c.send(l);i.push(u)}}catch(e){console.log(e)}return{channel:s,messages:i}}_ModalBuilder_instances=new WeakSet,_ModalBuilder_setCustomId=function(e){if(this.setCustomId)return this.setCustomId(e),this;throw new Error("Use only one of navigateTo or onClick methods.")};const DefaultTheme={primary:"#0070f3",danger:"#DA373C",success:"#248046",warning:"#ffb02e",info:"#0070f3"};function getTheme(){var e=(getContext(!0)||{})["theme"],e=hydrateTheme(e||DefaultTheme);return e.default=hydrateTheme(DefaultTheme),e}const needLightAndDarkTheme=["primary","danger","success","warning","info"];function hydrateTheme(e){e={...DefaultTheme,...e};for(const t of needLightAndDarkTheme)e[t+"Light"]=makeHexLighter(e[t]),e[t+"Dark"]=makeHexDarker(e[t]);return{...e,white:"#FFFFFF",black:"#000000",ghost:"#2b2d31"}}function hexToRgb(e){e=parseInt(e.slice(1),16);return{r:e>>16&255,g:e>>8&255,b:255&e}}function rgbToHex(e,t,o){return"#"+((1<<24)+(e<<16)+(t<<8)+o).toString(16).slice(1).toUpperCase()}function adjustBrightness(e,t){var{r:e,g:o,b:n}=hexToRgb(e);return rgbToHex(Math.max(0,Math.min(255,e+t)),Math.max(0,Math.min(255,o+t)),Math.max(0,Math.min(255,n+t)))}function makeHexDarker(e,t=20){return adjustBrightness(e,-t)}function makeHexLighter(e,t=20){return adjustBrightness(e,t)}function createUI(e){const{prefix:h="ui",routeDirectory:t="/ui",customRoutes:o=null,useFunctionalButtons:f=!1,functionalButtonTtl:n=1800,globalMetadata:g,slashCommands:p=[],slashCommandRegisterFunction:r=null,theme:a=DefaultTheme}=e||{};if(0<p.length&&!r)throw new Error("slashCommandRegisterFunction is required when slashCommands are provided");if(h.length>PREFIX_LENGTH)throw new Error("Prefix length cannot be more than 12 characters");if(h.includes(ARGS_DIVIDER))throw new Error(`Prefix cannot contain '${ARGS_DIVIDER}' character`);r&&0<p?.length&&r(p);const y=o?getRoutesFromCustomRoutes(o):getRoutesFromDirectory(t),w=createButtonCache(n);async function R(e,t){runWithContext({routes:y,interaction:e,globalMetadata:g,prefix:h,buttonCache:w,messageLayout:{},context:{},theme:a},async()=>{await navigate(t)})}return{openUI:R,onInteraction:function(m){runWithContext({routes:y,interaction:m,globalMetadata:g,prefix:h,buttonCache:w,messageLayout:{},context:{},theme:a},async()=>{if(m?.isChatInputCommand()){const l=m["commandName"];var e=p.find(e=>e?.command?.name===l);e&&(e=(e||{})["navigateTo"],e)&&R(m,e)}else if(m?.isButton()||m?.isModalSubmit()){var{customId:e=""}=m||{};if(e?.startsWith(h+ARGS_DIVIDER)){var t,o,n,r,[e,a,...s]=e.split(ARGS_DIVIDER);if(e===h){let e=null;if(m?.fields?.fields){e={};for(const d of m.fields.fields.keys())e[d]=m.fields.fields.get(d)?.value||null}switch(a){case"n":var[i,c]=s;switch(i){case"c":var u=getRouteFromUUID(c);if(!u)return;navigate(u);break;case"r":navigate(c)}break;case"f":f&&([i]=s,{routeName:t,params:o,searchParams:n,cleanPathname:r}=getUIFnAndRouteNameAndParams((i=w.get(i)).currentPathname,y),r={pathname:r||null,route:t,params:o,searchParams:n,interaction:m,globalMetadata:g,modal:e,context:{}},i?.fn?.(r))}}}}})}}}const setupFunctions={createUI:createUI,createRegisterSlashCommandsFunction:createRegisterSlashCommandsFunction},utilityFunctions={postChannelPrefab:postChannelPrefab,getTheme:getTheme},routeFunctions={render:render,reply:reply,deferRender:deferRender,navigate:navigate},builders={ButtonBuilder:ButtonBuilder,ModalBuilder:ModalBuilder},discordjsUI={...discordjs__namespace,...setupFunctions,...utilityFunctions,...routeFunctions,...builders};module.exports=discordjsUI;